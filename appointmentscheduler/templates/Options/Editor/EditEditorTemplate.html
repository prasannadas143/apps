{% extends "index.html" %}
{% load static from staticfiles %}
{% load admin_urls %}
{% load bootstrap3 %}
{% block title %}Dashboard{% endblock %}
{% block extraHeader %}
{% endblock %}
{% block content %}

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Editor Template</title>
        <script src="https://cdn.ckeditor.com/4.7.2/standard/ckeditor.js"></script>
        <script src="{% static 'ckeditor/js/Sample.js' %}" type="text/javascript"></script>
    </head>
    <body>
    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
         <input type="button"  class="btn-topGrid"  onclick="location.href='{% url 'appointmentschduler:TemplateDetailsList' %}'"  value=" List Template Details" />

     <form class="form-horizontal" role="form" method="POST">

    <input type="hidden" name="TemplateDetailID" id="TemplateDetailID" value="{% if templateinfo %} {{ templateinfo.TemplateID }} {% endif %}
">
    <div class="form-group">
    <label class="col-sm-6 control-label " for="Templates">Select Templates</label>
    <div class="col-sm-4">
    <select name="template" id="template" class="pj-form-field w180 custom-chosen TemplatesChange    form-control" >

                <option value="">-- Choose --</option>
                {% for template in listtemplates %}
                    <option value="{{ template.id }}" {% if templateinfo.TemplateID  == template.id %} selected {% endif %}>{{ template.templatename }}</option>
                {% endfor %}
    </select>
    </div>
    </div>
    <div>
    </div>    


  <div class="form-group">
    <label class="col-sm-6 control-label title " for="Subject">Subject</label>
    <div class="col-sm-4">
      <input type="text" name="subject_client" class="subject_client    form-control" value="{% if templateinfo %} {{ templateinfo.subject }} {% endif %}">
    </div>
  </div>

 <div class="form-group">
    <label class="col-sm-6 control-label editor1" for="Templateeditor1">Design Template</label>
    <div class="col-sm-12">
      <textarea name="editor1" class="DesignedTemplate    form-control">{% if templateinfo %} {{  templateinfo.DesignedTemplate }} {% endif %} </textarea>
    </div>
  </div>
    
  <div class="form-group">
  <label class="col-sm-6 control-label " for="Status">Status</label>
  <div class="col-sm-6">
  <input type="checkbox" name="Status" class="Status" 
  {% if templateinfo.status %}  checked {% endif %}>
  <div class="Status-msg red"></div>
  </div>
  </div> 

 <div class="form-group">
 <div class="col-md-offset-6 col-sm-6">
 <button class="btn btn-submit" type="button" onclick="return Validation();"> <i class="ace-icon fa fa-check"></i> Save Template </button>
 </div>
 </div>
        <script>
            CKEDITOR.replace( 'editor1' );
        </script>
        
        </form>
    </body>

<div class="modal fade" id="messageStatus" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header" style="text-align: center;">
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body" style="text-align: center;">
                <button type="button" data-dismiss="modal" class="btn btn-primary" id="Ok">Ok</button>
                <button type="button" data-dismiss="modal" class="btn">Cancel</button>
            </div>
        </div>
    </div>
</div>
    
</html>

<script type="text/javascript">
 function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}


$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            // Only send the token to relative URLs i.e. locally.
            xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
    },

    error: function(xhr, textStatus, error) {
        console.log(error);
    }
});
           
 $(".TemplatesChange").change(function () {
  $('#TemplateDetailID').val("");
  var TemplateID = this.value;

 $.ajax({
  url: "{% url 'appointmentschduler:GetTemplateDetails' %}",
  method: 'GET',
  data : {
          "TemplateID":TemplateID
         },
  }).success(function (data, jqXHR) 
  {
    if (data.id) {
       $('#TemplateDetailID').val(data.id);
    }
    else {
      $('#TemplateDetailID').val('');

    }
    if (data.subject) {

       $('.subject_client').val(data.subject);
    }
    else {
       $('.subject_client').val('');

    }
    if (data.DesignedTemplate) {
        var data = CKEDITOR.instances.editor1.setData(data.DesignedTemplate);
    }
     else {
       var data = CKEDITOR.instances.editor1.setData('');

    }
  }).error(function (jqXHR, errorThrown) {
     $('#TemplateDetailID').val("");
     $('.modal-title').text('error occured, Please try again.');
     $("#messageStatus").modal();
    }); 


    });

function Validation()
{
    var isValidForm=true;
    var data = CKEDITOR.instances.editor1.getData();
    var Subject =$('.subject_client').val();
    var TemplateID =$(".TemplatesChange option:selected").val()
    var TemplateDetailID =$('#TemplateDetailID').val().trim();

var status=1
if ($('.Status').is(":checked"))
{
  // it is checked
  status=1;
}
else{
  status=0;
}

    if(data=="")
    {
        isValidForm=false;
        alert("Please enter Template");
        return false;
    }

    if( Subject=="")
         {
        isValidForm=false;
        alert("Please enter subject");
        return false ;
    }
    
if(isValidForm) {


triggerurl = '/appointmentschduler/SaveEditorTemplate/' 
$.ajax({
  url: triggerurl,
  method: 'POST',
  data : {
          "TemplateID":TemplateID,
           "DesignedTemplate":data,
           "subject":Subject,
           "Status": status,
           "csrfmiddlewaretoken" : getCookie('csrftoken'),

         },
  }).success(function (data, jqXHR) 
  {
        $('.modal-title').text('Template saved successfully');
        $("#messageStatus").modal();
  }).error(function (jqXHR, errorThrown) {
     $('.modal-title').text('Template is not saved');
        $("#messageStatus").modal();
    }); 

    return true;
    }
    else
    {
         return false;
    }
 
}
</script>
{% endblock %}