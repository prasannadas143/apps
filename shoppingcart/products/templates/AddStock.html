{% extends "base.html" %}
{% load static from staticfiles %}
{% load admin_urls %}
{% load bootstrap3 %}
{% block title %}Dashboard{% endblock %}
{% block extraHeader %}
{% endblock %}
{% load js %}

{% block content %}
<style type="text/css">
	.red{
		color: Red;
	}

/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    -webkit-animation-name: fadeIn; /* Fade in the background */
    -webkit-animation-duration: 0.4s;
    animation-name: fadeIn;
    animation-duration: 0.4s
}

/* Modal Content */
.modal-content {
    position: fixed;
    bottom: 0;
    background-color: #fefefe;
    width: 100%;
    -webkit-animation-name: slideIn;
    -webkit-animation-duration: 0.4s;
    animation-name: slideIn;
    animation-duration: 0.4s
}

/* The Close Button */
.close {
    color: white;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}

.modal-header {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
}

.modal-body {padding: 2px 16px;}

.modal-footer {
    padding: 2px 16px;
    background-color: #5cb85c;
    color: white;
}

/* Add Animation */
@-webkit-keyframes slideIn {
    from {bottom: -300px; opacity: 0}
    to {bottom: 0; opacity: 1}
}

@keyframes slideIn {
    from {bottom: -300px; opacity: 0}
    to {bottom: 0; opacity: 1}
}

@-webkit-keyframes fadeIn {
    from {opacity: 0}
    to {opacity: 1}
}

@keyframes fadeIn {
    from {opacity: 0}
    to {opacity: 1}
}
</style>



<div>


    <form class="form-horizontal" role="form" action="/shoppingcart/Products/{{ id }}/InStock/" method="post" id="frmCreateProduct" enctype="multipart/form-data" onsubmit="return ValidateForm();" >{% csrf_token %}
        <div class="boxaddresses" id="stocks" name="stocks">

        <div id="myModal" class="modal">

              <!-- Modal content -->
              <div class="modal-content">
                    <div class="modal-header">
                      <span class="close" id="close">&times;</span>
                      <h2>Modal Header</h2>
                    </div>
                <div class="modal-body">


                </div>
                <div class="modal-footer">
                  <h3>Modal Footer</h3>
                </div>
              </div>

        </div>
         <div class="boxaddress" >

             <span> Image </span>

            {% for attr_name in attributes  %}
                <span>{{ attr_name.attr_name }}</span>
            {% endfor %}
            <span> Quantity </span>
            <span> Price </span>
         </div>
        </div>
         {% if showattributes == 1 %}
            <input type="button" value="AddCombination" class="pj-button" onclick="AddStockrow()" >
        {% endif %}
         <p>
            <label class="title">&nbsp;</label>
            <input type="submit" value="Save" class="pj-button"  onclick="ValidateForm()">
            <input type="button" value="Cancel" class="pj-button">
         </p>
    </form>
</div>

<script>


// Django CSRF framework
$(document).ajaxSend(function(event, xhr, settings) {
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function sameOrigin(url) {
        // url could be relative or scheme relative or absolute
        var host = document.location.host; // host + port
        var protocol = document.location.protocol;
        var sr_origin = '//' + host;
        var origin = protocol + sr_origin;
        // Allow absolute or scheme relative URLs to same origin
        return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
            (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
            // or any other URL that isn't scheme relative or absolute i.e relative.
            !(/^(\/\/|http:|https:).*/.test(url));
    }
    function safeMethod(method) {
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
    }
});
var stockdetails = {{ stockdetails | js }};
var i = 1 ;
var showattributes = {{ showattributes |js }};
var attributes = {{ attributes|js }} ;

function delstock() {
    srcelement = event.srcElement ;
    uri = srcelement.baseURI
    stockhtmlid = srcelement.id
    delete_stock_id  = srcelement.value;
    var re = /\/shoppingcart\/products\/(\d+)\//i;
    var found = uri.match(re);
    productid = found[1];
    console.log( productid );
    console.log( stockhtmlid );

    $.ajax({
              url: "/shoppingcart/Products/" + productid + "/deletestock/" ,
              method: 'POST',
              data :
              { stock_id : delete_stock_id },
        }).success(function (data, textStatus, jqXHR) {

                var re = /stock_delete_(\d+)/i;
                var found = stockhtmlid.match(re);
                stockid = found[1];
                stockid =  "stock_" +  stockid
               $("#" + stockid).remove();
               i -= 1

          }).error(function (jqXHR, textStatus, errorThrown) {
            console.log(jqXHR)
   });

}



// Get the modal
var modal = document.getElementById('myModal');

// Get the <span> element that closes the modal
var span = document.getElementById("close");

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    modal.style.display = "none";
    modalbody.empty()

}
 modalbody = $(".modal-body")
var clickedimage ;
function browseimage() {
  event.stopPropagation();
    modal.style.display = "block";
    srcelement = event.srcElement ;
    clickedimage = srcelement;
    uri = srcelement.baseURI
    clickedimageid = srcelement.id
    var re = /\/shoppingcart\/products\/\d+\//i;
    var found = uri.match(re);
    url = found[0];
   	element_id = srcelement.id ;
    $.ajax({
          url: url + "listimages/",

          method: 'POST',
      }).success(function (data, textStatus, jqXHR) {
            for (var photo in data) {
             <!--console.log(data[photo].imageid);-->
             <!--console.log( data[photo].imageurl );-->
             img  = addimgelement("" , data[photo].imageid ) ;
             img.src = data[photo].imageurl;
             img.onclick = addimagtostock

             modalbody.append(img);
            }



      }).error(function (jqXHR, textStatus, errorThrown) {
          console.log(jqXHR);
      });

}

function addHiddenField( fieldName, fieldValue){
	   var hiddenelement = document.createElement("input");
	   hiddenelement.type = "hidden";
	   hiddenelement.name = fieldName;
	   hiddenelement.id = fieldName;
	   hiddenelement.value = fieldValue;
       return hiddenelement ;
}

function addimagtostock() {

    srcelementid = event.srcElement.id ;
   	clickedimageid = clickedimage.id
    parentnode = clickedimage.parentNode;
    parentnode.removeChild(clickedimage);
    img  = addimgelement("" , clickedimageid ) ;
    img.src = event.srcElement.src;
    img.onclick = browseimage;
    imageid = img.id
    parentnode.insertBefore(img, parentnode.childNodes[0]);
	var re = /img_(\d+)/i;
    var found = imageid.match(re);
    rowid = found[1];
    fieldName = "img_hd_" + rowid
    fieldValue = srcelementid
    img.name = fieldValue;
    hd = document.getElementById( fieldName );
    if(hd == null || hd == '') {
        hd = addHiddenField( fieldName, fieldValue );
        parentnode.appendChild( hd );
    }
    hd.value = fieldValue;
    modal.style.display = "none";
    modalbody.empty()
}
function creatediv( id ) {

	var para_attr = document.createElement('div');
	para_attr.setAttribute('name',id );
	para_attr.setAttribute('id', id );
	para_attr.innerHTML = "";
    return para_attr;
}

function createpara( id ) {

	var para_attr = document.createElement('p');
	para_attr.setAttribute('name',id );
	para_attr.setAttribute('id', id );
	para_attr.innerHTML = "";
    return para_attr;
}

function createbutton( id, label, innerhtml ) {

	var addbutton = document.createElement('button');
	addbutton.setAttribute('type', "button");
	addbutton.setAttribute('name', id );
	addbutton.setAttribute('id', id );
	addbutton.innerHTML = innerhtml;
    return addbutton;
}

function addtext(label, placeholder,id) {
	var y = document.createElement("INPUT");
	y.setAttribute("type", "text");
	y.setAttribute("placeholder", placeholder);
	y.setAttribute("id", id );
	y.setAttribute("name", id );
	y.setAttribute("required",true);
	return y;
}

function addmessagediv( namefield  ){

        var msg = document.createElement("span");
        msg.setAttribute("id", namefield );
        msg.setAttribute("name",  namefield );
        msg.setAttribute("class",  namefield );
        return msg;
}

function addimgelement(label,id) {
     var x = document.createElement("IMG");
    x.setAttribute("src", "");
    x.setAttribute("id", id);
    x.setAttribute("name",id);
    x.setAttribute("height", "200");
    x.setAttribute("width", "400");
    x.setAttribute("alt", "suppp");
    return x
}

function addimg(label,id) {
	var y = document.createElement("span");
	y.setAttribute("id", "span" + id );
	y.setAttribute("name", "span" + id );

	var im_btn = document.createElement("button");
	im_btn.setAttribute("id", id );
	im_btn.setAttribute("name", id );
    im_btn.innerHTML= "choose image";
    y.appendChild(im_btn);
	return y;
}
function AddStockrow( stockid = null) {
        if( i == 0) {
         i=1;
         }
        <!-- Get Stocks Div-->
        var stocksrow = document.getElementById("stocks" );

        <!-- Get Stock Div-->
        var stockrow = document.createElement("div");
        stockrow.setAttribute("id", "stock_" + i);
        stockrow.setAttribute("name", "stock_" + i);
        stockrow.setAttribute("class", "boxaddress" );
        stocksrow.appendChild(stockrow);
	 <!--<div class="Alpha3-msg red"></div>-->

        <!-- Create Stock Para-->
        id = "para_stock_name_" + i
        divtag = creatediv( id);

        msgbox = "_msg"

        <!-- Create Image File-->

        if( stockid ) {

            imgid = "img_" + i ;
            img  = addimgelement("" , imgid ) ;
            img.onclick = browseimage
            divtag.appendChild(img);
        }
        else {
            label ="";
            id = "img_" + i ;
            img = addimg(label,id)
            img.onclick = browseimage;
            divtag.appendChild( img );
        }

     <!-- Create Image File messages -->

        namefield = "img_" + i + msgbox;
        msgtag = addmessagediv( namefield , msgbox );
        divtag.appendChild( msgtag );
        for (at in attributes) {
            dropdown = createdropdown(i, attributes[at]);
            divtag.appendChild( dropdown );

        }
        <!-- Create Qty data-->
        label = "";
        placeholder = "Quantity ";
        id = "qty_" + i;
        txt = addtext(label, placeholder,id);

        divtag.appendChild( txt );

        <!-- Create Qty messages -->
        namefield = "qty_" + i + msgbox ;
        msgtag = addmessagediv( namefield , msgbox );
        divtag.appendChild( msgtag );

        <!-- Create  Price-->
        label = "";
        placeholder = "Price ";
        id = "price_" + i;
        txt = addtext(label, placeholder,id);
        divtag.appendChild( txt );

        <!-- Create price messages -->
        namefield = "price_" + msgbox;
        msgtag = addmessagediv( namefield , msgbox );
        divtag.appendChild( msgtag );


        id =  'stock_delete_' + i;
        label = "" ;
        innerhtml =  "Delete";
        button = createbutton( id, label, innerhtml )
        button.onclick = delstock;
        divtag.appendChild( button );
        stockrow.appendChild( divtag );
        i+=1 ;
        return stockrow;
 }

function createdropdown( i, attribute ) {

	dropdown_attr_name  = attribute['attr_name'] + "_" + i
	var select = document.createElement("select");
	select.id = dropdown_attr_name;
	select.name= dropdown_attr_name;
	attr_values  = attribute['attrvalues'];

	for (atv in attr_values) {

		var option = document.createElement("option");
		attr_value = attr_values[atv]
		option.value = attr_value['attrid'] ;
		option.text = attr_value['attr_value'] ;
		<!--console.log( attr_value['attr_value'] );-->
		<!--option.selected="";-->
		<!--option.innerHTML= "";-->
		select.appendChild(option);

	}
    return select;
}

function ValidateForm() {
   var divElem = document.getElementById("stocks");
   var inputElements = divElem.querySelectorAll("input, file, text");
    for (var inputElement of inputElements) {
        elementid = inputElement.id;
        element_value = inputElement.value;

    }
}

 function CreateStockRow() {

    for ( stock_cnt in stockdetails ) {
        stockid = stockdetails[ stock_cnt ]["id"]
        stockrow = AddStockrow( stockid );
        stockrowid = stockrow.id
        var re = /stock_(\d+)/i;
        var found = stockrowid.match(re);
        rowid = found[1];
        stockid = stockdetails[ stock_cnt ]['id']
        if ( stockid) {
            var qty = document.getElementById("qty_" + rowid);
            var price = document.getElementById("price_" + rowid);
            var img = document.getElementById("img_" + rowid );
            qty.value = stockdetails[ stock_cnt ]["qty"] ;
            price.value = stockdetails[ stock_cnt ]["price"];
            img.src = stockdetails[ stock_cnt ]["imagepath"]
            fieldName = "img_hd_" + rowid
            fieldValue = stockdetails[ stock_cnt ]["imageid"];
            hd = addHiddenField( fieldName, fieldValue );
            stockrow.appendChild(hd);
            fieldName = "stockid_" + rowid ;
            fieldValue = stockid;
            hsid = addHiddenField( fieldName, fieldValue );
            stockrow.appendChild(hsid);
            stock_attribute_details = stockdetails[ stock_cnt ][ "stock_attribute_details" ]
            delete_id = "stock_delete_" + rowid ;
            var stock_delete = document.getElementById( delete_id );
            stock_delete.value  = stockid ;
            for ( st_at_cnt in stock_attribute_details ) {
                stock_attribute_id =  stock_attribute_details[ st_at_cnt ]["attributeid"] ;
                <!--stock_attribute_value =  stock_attribute_details[ st_at_cnt ]["stock_attr_value"] ;-->
                attr_name = stock_attribute_details[ st_at_cnt ]["stock_attr_name"]
                attr_name_field = attr_name + "_" + rowid ;
                var attr_dropdown = document.getElementById( attr_name_field );
                for (var di = 0; di < attr_dropdown.length; di++)
                {   attr_index = attr_dropdown.options[di]
                    if ( attr_index.value == stock_attribute_id.toString() ) {
                        attr_index.selected="true";

                    }
                }
            }

        }
        stockid = ""

    }
}

 $(document).ready(function(){


    CreateStockRow();

});
</script>

{% endblock %}
